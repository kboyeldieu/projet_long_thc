<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.rawgit.com/konvajs/konva/1.7.6/konva.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdn.rawgit.com/jcubic/jquery.terminal/master/js/jquery.terminal.min.js"></script>
  <link href="https://cdn.rawgit.com/jcubic/jquery.terminal/master/css/jquery.terminal.min.css" rel="stylesheet"/>
  <meta charset="utf-8">
  <title>Attaque par injection de faute sur RSA-CRT</title>
  <style>

    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #FFFFFF;
    }

    .disabled {
      cursor: not-allowed;
      color: white;
      background-color: #DDD;
    }

    .top-bar {
      width: 100%; /* Set a specific width */
      padding: 20px 0px;
      background-color: #DDD; /* Dark-grey background */
      transition-duration: 0.4s;
      text-align: center;
      font-size: 25px;
    }

    .done {
      background-color: #27AE60;
      color: white;
    }

    .almost-done {
      background-color: #F39C12;
      color: white;
    }

    .wrong {
      background-color: #e74c3c;
      color: white;
    }

    #container {
      position:fixed;
      top: 45%;
      left: 48%;
      margin-top: -250px;
      margin-left: -233px;
      width:500;
      height:467;
      cursor:url(cursor.cur),url(/static/cursor.cur),default;
    }

    #console {
      position: absolute;
      top: 80%;
      left: 15%;
      width: 70%;
      height: 15%;
      border-radius: 6px;
    }

    .terminal, .cmd, .terminal .terminal-output div div, .cmd .prompt {
      font-size: 14px;
      color:#FFFFFF;
      line-height: 20px;
    }

  </style>
</head>
<body>
  <div class="top-bar" id="topBar"> Utilise le laser sur la carte FPGA au bon moment et au bon endroit pour fauter le calcul et retrouver les facteurs premiers.</div>
  <div id="container"></div>
  <div id="console"></div>

  <script>

    $('#console').terminal(function(command) {
      var terminal = this;
      var command = command.toLowerCase();
      if (command.startsWith('solution')) {
        handleSolutionCommand(terminal, command);  
      } else if (command.startsWith('pgcd')) {
        handlePGCDCommand(terminal, command);
      } else if (command === 'signature') {
        handleSignatureCommand(terminal, command);
      } else if (command.startsWith('multiplication') || command.startsWith('addition') || command.startsWith('soustraction') || command.startsWith('division')) {
        handleArithmeticCommand(terminal,command);
      } else if (command === 'clean') {
        terminal.purge();
      } else if (command.trim() !== '') {
        terminal.echo("Commande inconnue.");
      }
    }, { prompt: '> ',
         wrap: true,
         greetings: "[[ib;white;]Même consigne que précédemment pour p et q tels que p*q = [[i;red;]0x2fa47df91c352f3112cb]. Sert toi à présent du laser sur la carte ci-dessus afin de fauter le calcul.\n\n]"
    });

    function handleSolutionCommand(terminal, command) {
      var p, q;
      var correct_syntax = true;
      var params = command.split(' ');
      if (params.length != 3) {
        correct_syntax = false;
      } else {
        p = params[1];
        q = params[2];
        if (p.length < 3 || q.length < 3 ||  !(p.startsWith("0x")) || !(q.startsWith("0x"))) {
          correct_syntax = false;
        } else {
          for (i=2; i < p.length; i++) {
            if (!("0123456789abcdef".includes(p[i]))) {
              correct_syntax = false;
            }
          }
          for (i=2; i < q.length; i++) {
            if (!("0123456789abcdef".includes(q[i]))) {
              correct_syntax = false;
            }
          }
        }
      }
      if (correct_syntax) {
        $.getJSON('/tutorial1/check-answer?p=' + p + '&q=' + q,         
          function(data, textStatus, jqXHR) {
            if (data == 2) {
              topBar.className = "top-bar done";
              nextButton.className = "next";
              terminal.echo("[[;#27AE60;]Bravo!]");
            } else if (data === 1) {
              topBar.className = "top-bar almost-done";
              nextButton.className = "next disabled";
              terminal.echo("[[;#F39C12;]Tu chauffes!]");
            } else {
              topBar.className = "top-bar wrong";
              nextButton.className = "next disabled";
              terminal.echo("[[;#E74C3C;]Mauvaise réponse.]");
            }
          }
        );
      } else {
        if (command === 'solution' || command.startsWith("solution ")) {
          terminal.echo('Usage : solution hexadecimal1 hexadecimal2');
        } else {
          terminal.echo('Commande inconnue.');
        }
      }
    }

    function handlePGCDCommand(terminal, command) {
      var a, b;
      var correct_syntax = true;
      var params = command.split(' ');
      if (params.length != 3) {
        correct_syntax = false;
      } else {
        a = params[1];
        b = params[2];
        if (a.length < 3 || b.length < 3 ||  !(a.startsWith("0x")) || !(b.startsWith("0x"))) {
          correct_syntax = false;
        } else {
          for (i=2; i < a.length; i++) {
            if (!("0123456789abcdef".includes(a[i]))) {
              correct_syntax = false;
            }
          }
          for (i=2; i < b.length; i++) {
            if (!("0123456789abcdef".includes(b[i]))) {
              correct_syntax = false;
            }
          }
        }
      }
      if (correct_syntax) {
        $.getJSON('/get-pgcd?a=' + a + '&b=' + b,         
          function(data, textStatus, jqXHR) {
            terminal.echo(data);
          }
        );
      } else {
        if (command === "pgcd" || command.startsWith("pgcd ")) {
          terminal.echo('Usage : pgcd hexadecimal1 hexadecimal2');
        } else {
          terminal.echo('Commande inconnue.');
        }
      }
    }

    function handleArithmeticCommand(terminal, command) {
      var op, a, b;
      var correct_syntax = true;
      var params = command.split(' ');
      if (params.length != 3) {
        correct_syntax = false;
      } else {
        op = params[0];
        a = params[1];
        b = params[2];
        if (a.length < 3 || b.length < 3 ||  !(a.startsWith("0x")) || !(b.startsWith("0x"))) {
          correct_syntax = false;
        } else {
          for (i=2; i < a.length; i++) {
            if (!("0123456789abcdef".includes(a[i]))) {
              correct_syntax = false;
            }
          }
          for (i=2; i < b.length; i++) {
            if (!("0123456789abcdef".includes(b[i]))) {
              correct_syntax = false;
            }
          }
        }
      }
      if (correct_syntax) {
        $.getJSON('/arithmetic?op=' + op + '&a=' + a + '&b=' + b,         
          function(data, textStatus, jqXHR) {
            terminal.echo(data);
          }
        );
      } else {
        if (command === "adition" || command.startsWith("addition ")) {
          op = "addition";
          terminal.echo('Usage : ' + op + ' hexadecimal1 hexadecimal2');
        } else if (command === "multiplication" ||command.startsWith("multiplication ")) {
          op = "multiplication";
          terminal.echo('Usage : ' + op + ' hexadecimal1 hexadecimal2');
        } else if (command === "soustraction" ||command.startsWith("soustraction ")) {
          op = "soustraction";
          terminal.echo('Usage : ' + op + ' hexadecimal1 hexadecimal2');
        } else if (command === "division" ||command.startsWith("division ")) {
          op = "division";
          terminal.echo('Usage : ' + op + ' hexadecimal1 hexadecimal2');
        } else {
          terminal.echo('Commande inconnue.');
        }
      }
    }

    function handleSignatureCommand(terminal) {
      $.getJSON('/get_last_signature',         
        function(data, textStatus, jqXHR) {
          terminal.echo(data).set_prompt("> ");
      });
    }

    var width = 500;
    var height = 467;

    var imageLayer, drawLayer, nexysImg;
    var topBar = document.getElementById("topBar");
    var inputP = document.getElementById("input-p");
    var inputQ = document.getElementById("input-q");

    var stage = new Konva.Stage({
        container: 'container',
        width: width,
        height: height,
    });

    imageLayer = new Konva.Layer();
    drawLayer = new Konva.Layer();

    nexysImg = new Image();
    nexysImg.onload = function() {
      imageLayer.getContext().drawImage(nexysImg,0,0,500,467);
    };
    nexysImg.src = '/static/nexys2.png';

    stage.add(imageLayer);
    stage.add(drawLayer);

    function checkAnswer() {
      var p = inputP.value.toLowerCase();
      var q = inputQ.value.toLowerCase();
      $.getJSON('/tutorial2/check-answer?p=' + p + '&q=' + q,         
        function(data, textStatus, jqXHR) {
          if (data == 2) {
            topBar.className = "top-bar done";
            window.alert("Tu as terminé le tutoriel d'attaque par injection de faute. Bravo!");
          } else if (data === 1) {
            topBar.className = "top-bar almost-done";
          } else {
            topBar.className = "top-bar wrong";
          }
        }
      );
    }
    
    function laserOn() {
      var x = parseInt(stage.getPointerPosition().x);
      var y = parseInt(stage.getPointerPosition().y);
      var circle = new Konva.Circle({
          x: x + 20,
          y: y + 21,
          stroke:'#FF3901',
          strokeWidth:5,
          radius: 2.5,
      });
      drawLayer.add(circle).draw();
      $.getJSON('/tutorial2/send-fault?x=' + x + '&y=' + y,       
        function(data, textStatus, jqXHR) {
        }
      );
    }

    stage.on('contentClick', laserOn);
  </script>

</body>
</html>